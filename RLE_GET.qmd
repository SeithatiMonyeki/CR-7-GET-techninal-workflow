---
title: "7th Country Reporting"
---

```{r setup}

#if (!requireNamespace(c("magrittr","dplyr", "ggplot2", "ggthemes"), quietly = TRUE)) {
#  install.packages(c("magrittr","dplyr", "ggplot2", "ggthemes"))
#}

#devtools::install_github("SANBI-NBA/nbaR", force = T)

library(nbaR)
library(dplyr)
library(tidyr)
library(rlang)
library(gt)
library(ggplot2)
library(here)
library(scales)
library(stringr)
```

::: scrolling
```{r}

EDD.GET_names <- read.csv("./data/EDD_GET levels names.csv") %>%
                 mutate(GET_L2.code_text = paste(IUCN_GET_2025_L2, GET_L2.text, sep = ": ")) %>%
                 mutate(GET_L3.code_text = paste(IUCN_GET_2022_L3, GET_L3.text, sep = ": ")) %>%
  
                 group_by(IUCN_GET_2025_L2) %>%
                 mutate(n.get_L2 = n_distinct(EcosystemType_GETLevel5_6)) %>%
                 ungroup() %>%
  
                 group_by(IUCN_GET_2022_L3) %>%
                 mutate(n.get_L3 = n_distinct(EcosystemType_GETLevel5_6)) %>%  # or whatever L4 column you want to count
                 ungroup()  %>%  
  
                 mutate(GET_L2.count = paste0(GET_L2.code_text, " (n = ", n.get_L2, " ecosystems)"),
                        GET_L3.count = paste0(GET_L3.code_text, " (n = ", n.get_L3, " ecosystems)")) %>%
  
                 select(Realm_GETL1, Code,`Biome..GET.L3._Ecosystem_Fuctional_Groups..GET.Level.3.`, EcosystemType_GETLevel5_6, RLE_2025, EPL_2025, IUCN_GET_2025_L2, IUCN_GET_2022_L3, GET_L2.count, GET_L3.count) %>%

                 mutate(Realm = case_when(Realm_GETL1 == "Freshwater_Wetland" ~ "Wetland",
                                          Realm_GETL1 == "Freshwater_River"   ~ "River", TRUE ~ Realm_GETL1),
                        
                        RLE_2025 = factor(RLE_2025, levels = c("LC", "NT", "VU", "EN", "CR"), 
                                                    labels = c("Least Concern", "Near Threatened","Vulnerable", "Endangered", "Critically Endangered")))

```
:::

::: scrolling
```{r}

# First, create a lookup for realm order
GET_L2.realm_order <- EDD.GET_names %>%
                      distinct(GET_L2.count, Realm) %>%
                      mutate(Realm = factor(Realm, levels = c("Terrestrial", "River", "Wetland", "Estuarine", "Marine"))) %>%
                      arrange(Realm, GET_L2.count)

GET_L3.realm_order <- EDD.GET_names %>%
                      distinct(GET_L3.count, Realm) %>%
                      mutate(Realm = factor(Realm, levels = c("Terrestrial", "River", "Wetland", "Estuarine", "Marine"))) %>%
                      arrange(Realm, GET_L3.count)

#  -------1.  Number of Ecosystem Types (GET_L5/6) per Threat Status within each IUCN GET 2025 Level 3 -------

GET_L2.RLE <- EDD.GET_names %>%
              group_by(GET_L2.count, RLE_2025) %>%
              summarise(n = n_distinct(EcosystemType_GETLevel5_6), .groups = "drop") %>%
              tidyr::pivot_wider(names_from = RLE_2025,
                                 values_from = n,
                                 values_fill = 0) %>%
              mutate(Total = rowSums(select(., -GET_L2.count)))  %>%
              rowwise() %>%
              mutate(Threat_total = sum(across(c(`Vulnerable`, `Endangered`, `Critically Endangered`))),
                     Threat_prc = round((Threat_total/Total) * 100, 0)) %>%
              ungroup() %>%
              # Apply the realm-based ordering
              mutate(GET_L2.count = factor(GET_L2.count, 
                                          levels = GET_L2.realm_order$GET_L2.count)) %>%
              arrange(GET_L2.count)

#  -------2.  Number of Ecosystem Types (GET_L5/6) per Threat Status within each IUCN GET 2025 Level 3 -------

GET_L3.RLE <- EDD.GET_names %>%
              group_by(GET_L3.count, RLE_2025) %>%
              summarise(n = n_distinct(EcosystemType_GETLevel5_6), .groups = "drop") %>%
              tidyr::pivot_wider(names_from = RLE_2025,
                                 values_from = n,
                                 values_fill = 0) %>%
              mutate(Total = rowSums(select(., -GET_L3.count)))  %>%
              rowwise() %>%
              mutate(Threat_total = sum(across(c(`Vulnerable`, `Endangered`, `Critically Endangered`))),
                     Threat_prc = round((Threat_total/Total) * 100, 0)) %>%
              ungroup() %>%
              mutate(GET_L3.count = factor(GET_L3.count, 
                                          levels = GET_L3.realm_order$GET_L3.count)) %>%
              arrange(GET_L3.count)


files <- list(EDD.GET_biomes = EDD.GET_names,
              GET_L2.RLE = GET_L2.RLE,
              GET_L3.RLE = GET_L3.RLE)

purrr::iwalk(files, ~ writexl::write_xlsx(.x, paste0("./data/", .y, ".xlsx")))


```
:::



```{r Function, echo=FALSE}

plot_rle_bar_wide <- function(data,
                              group_var,
                              levels_vec,
                              y_label = NULL,
                              show_legend = TRUE,
                              caption = NULL,
                              text_size = 8,
                              label_size = 2.3,
                              bar_width = 0.7) {

  # ---- Required libraries ----
  library(dplyr)
  library(tidyr)
  library(ggplot2)
  library(scales)

  # ---- Define Red List of Ecosystems (RLE) categories ----
  rle_cols <- c(
    "Least Concern",
    "Near Threatened",
    "Vulnerable",
    "Endangered",
    "Critically Endangered"
  )

  # ---- Reshape data to long format & prepare factors ----
  df_long <- data %>%
    pivot_longer(
      cols = all_of(rle_cols),
      names_to  = "RLE",
      values_to = "Count"
    ) %>%
    mutate(
      RLE = factor(RLE, levels = rle_cols),
      {{ group_var }} := factor(
        {{ group_var }},
        levels = if (rlang::as_name(rlang::enquo(group_var)) == "Realm") {
          c("Estuarine", "Marine", "Wetland", "River", "Terrestrial")
        } else {
          levels_vec
        }
      )
    ) %>%
    group_by({{ group_var }}) %>%
    mutate(prop = Count / sum(Count)) %>%
    ungroup()

  # ---- Build stacked proportional bar plot ----
  p <- ggplot(df_long, aes(y = {{ group_var }}, x = prop, fill = RLE)) +
    geom_bar(stat = "identity", position = "fill", width = bar_width) +
    geom_text(
      aes(label = ifelse(Count == 0, "", Count)),
      position = position_fill(vjust = 0.5),
      size = label_size
    ) +
    scale_x_continuous(
      breaks = c(0, 0.5, 1),
      labels = scales::percent_format(accuracy = 1)
    ) +
    scale_fill_manual(
      values = c("#B4D79E", "#CCE226", "#FFE800", "#FFAF42", "#CC0000"),
      name = NULL,
      guide = guide_legend(reverse = TRUE)
    ) +

    # ---- Y-axis labels without any wrapping ----
    scale_y_discrete(labels = function(x) x) +

    labs(
      x = "Percentage of ecosystem types",
      y = y_label,
      caption = caption
    ) +

    theme_minimal(base_size = text_size) +
    theme(
      panel.grid.major.y = element_blank(),
      panel.grid.minor.y = element_blank(),
      panel.grid.minor.x = element_blank(),
      panel.grid.major.x = element_line(color = "grey80", size = 0.04),
      axis.title.x = element_text(size = 8),
      axis.title.y = element_text(size = 8),
      axis.text.y  = element_text(lineheight = 0.95),
      legend.title = element_blank(),
      legend.key.height = unit(0.4, "cm"),
      legend.key.width  = unit(0.35, "cm")
    )

  # ---- Legend control ----
  if (show_legend) {
    p <- p + theme(
      legend.position = "bottom",
      legend.direction = "horizontal",
      legend.box = "horizontal"
    )
  } else {
    p <- p + theme(legend.position = "none")
  }

  return(p)
}


```

## 


```{r}
#| label: fig-3
#| fig.height: 4
#| out.width: 100% 

GET_L2 <- plot_rle_bar_wide(GET_L2.RLE,
                            group_var  = GET_L2.count,
                            levels_vec = rev(levels(GET_L2.RLE$GET_L2.count)),
                            y_label    = "IUCN Global Ecosystem Typology Level 2",
                            bar_width  = 0.5)
GET_L2


```


```{r}
#| label: fig-4
#| fig.height: 8
#| out.width: 100% 

GET_L3 <- plot_rle_bar_wide(GET_L3.RLE,
                            group_var  = GET_L3.count,
                            levels_vec = rev(levels(GET_L3.RLE$GET_L3.count)),
                            y_label    = "IUCN Global Ecosystem Typology Level 3",
                            bar_width  = 0.5)
GET_L3

```